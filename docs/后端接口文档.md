# CashLog API 接口文档

## 概述

CashLog API 是一个轻量化本地记账/待办管理系统的后端接口，提供完整的交易记录管理、待办事项管理、报表生成和数据备份功能。

**基础URL**: `http://localhost:8000/api`

**认证**: 当前版本不需要认证（后续可添加）

**数据格式**: JSON

**字符编码**: UTF-8

## 目录

- [待办事项 API](#待办事项-api)
- [交易记录 API](#交易记录-api)
- [报表生成 API](#报表生成-api)
- [数据管理 API](#数据管理-api)
- [数据模型](#数据模型)
- [错误处理](#错误处理)

---

## 待办事项 API

### 获取待办事项列表

**请求**: `GET /todos`

**描述**: 根据条件查询待办事项列表，支持分页

**查询参数**:
- `status` (可选): 待办状态，可选值：`todo`, `doing`, `done`
- `category` (可选): 待办分类
- `deadline_before` (可选): 截止时间之前，格式：YYYY-MM-DD
- `deadline_after` (可选): 截止时间之后，格式：YYYY-MM-DD
- `tags` (可选): 标签，多个标签用逗号分隔

**响应示例**:
```json
{
  "items": [
    {
      "id": 1,
      "content": "完成项目报告",
      "category": "工作",
      "tags": "重要,紧急",
      "deadline": "2024-12-10T18:00:00",
      "transaction_id": null,
      "status": "todo",
      "created_at": "2024-12-01T09:00:00",
      "updated_at": "2024-12-01T09:00:00",
      "status_text": "待办"
    }
  ],
  "total": 1,
  "page": 1,
  "size": 10,
  "pages": 1
}
```

### 获取单个待办事项

**请求**: `GET /todos/{todo_id}`

**描述**: 根据ID查询单个待办事项的详细信息

**路径参数**:
- `todo_id`: 待办事项ID

**响应示例**:
```json
{
  "id": 1,
  "content": "完成项目报告",
  "category": "工作",
  "tags": "重要,紧急",
  "deadline": "2024-12-10T18:00:00",
  "transaction_id": null,
  "status": "todo",
  "created_at": "2024-12-01T09:00:00",
  "updated_at": "2024-12-01T09:00:00",
  "status_text": "待办"
}
```

### 创建待办事项

**请求**: `POST /todos`

**描述**: 创建新的待办事项

**请求体**:
```json
{
  "content": "完成项目报告",
  "category": "工作",
  "tags": "重要,紧急",
  "deadline": "2024-12-10T18:00:00",
  "transaction_id": null,
  "status": "todo"
}
```

**必填字段**:
- `content`: 待办内容
- `category`: 待办分类

**可选字段**:
- `tags`: 待办标签
- `deadline`: 截止时间 (ISO 8601 格式)
- `transaction_id`: 关联交易ID
- `status`: 待办状态 (默认为 "todo")

**响应**: 返回创建的待办对象，状态码 201

### 更新待办事项

**请求**: `PUT /todos/{todo_id}`

**描述**: 根据ID更新待办事项的信息

**路径参数**:
- `todo_id`: 待办事项ID

**请求体**:
```json
{
  "content": "完成项目报告",
  "category": "工作",
  "tags": "重要,紧急",
  "deadline": "2024-12-10T18:00:00",
  "transaction_id": null,
  "status": "doing"
}
```

**响应**: 返回更新后的待办对象

### 删除待办事项

**请求**: `DELETE /todos/{todo_id}`

**描述**: 根据ID删除待办事项

**路径参数**:
- `todo_id`: 待办事项ID

**响应**: 空内容，状态码 204

---

## 交易记录 API

### 获取交易记录列表

**请求**: `GET /transactions`

**描述**: 根据条件查询交易记录列表，支持分页

**查询参数**:
- `month` (可选): 交易月份，格式：YYYY-MM
- `category` (可选): 交易分类
- `tags` (可选): 标签，多个标签用逗号分隔
- `transaction_type` (可选): 交易类型，可选值：`income`（收入）, `expense`（支出）

**响应示例**:
```json
{
  "items": [
    {
      "id": 1,
      "amount": 5000.0,
      "category": "工资",
      "tags": "收入,月度",
      "notes": "12月份工资",
      "created_at": "2024-12-01T09:00:00",
      "updated_at": "2024-12-01T09:00:00",
      "transaction_type": "收入",
      "month": "2024-12"
    },
    {
      "id": 2,
      "amount": -150.0,
      "category": "餐饮",
      "tags": "日常,午餐",
      "notes": "工作日午餐",
      "created_at": "2024-12-01T12:30:00",
      "updated_at": "2024-12-01T12:30:00",
      "transaction_type": "支出",
      "month": "2024-12"
    }
  ],
  "total": 2,
  "page": 1,
  "size": 10,
  "pages": 1
}
```

### 获取单个交易记录

**请求**: `GET /transactions/{transaction_id}`

**描述**: 根据ID查询单个交易记录的详细信息

**路径参数**:
- `transaction_id`: 交易记录ID

**响应示例**:
```json
{
  "id": 1,
  "amount": 5000.0,
  "category": "工资",
  "tags": "收入,月度",
  "notes": "12月份工资",
  "created_at": "2024-12-01T09:00:00",
  "updated_at": "2024-12-01T09:00:00",
  "transaction_type": "收入",
  "month": "2024-12"
}
```

### 创建交易记录

**请求**: `POST /transactions`

**描述**: 创建新的交易记录

**请求体**:
```json
{
  "amount": 5000.0,
  "category": "工资",
  "tags": "收入,月度",
  "notes": "12月份工资",
  "created_at": "2024-12-01T09:00:00"
}
```

**必填字段**:
- `amount`: 交易金额（正数为收入，负数为支出）
- `category`: 交易分类

**可选字段**:
- `tags`: 交易标签
- `notes`: 交易备注
- `created_at`: 交易时间 (ISO 8601 格式，默认为当前时间)

**响应**: 返回创建的交易对象，状态码 201

### 更新交易记录

**请求**: `PUT /transactions/{transaction_id}`

**描述**: 根据ID更新交易记录的信息

**路径参数**:
- `transaction_id`: 交易记录ID

**请求体**:
```json
{
  "amount": 5000.0,
  "category": "工资",
  "tags": "收入,月度",
  "notes": "12月份工资（含奖金）",
  "created_at": "2024-12-01T09:00:00"
}
```

**响应**: 返回更新后的交易对象

### 删除交易记录

**请求**: `DELETE /transactions/{transaction_id}`

**描述**: 根据ID删除交易记录

**路径参数**:
- `transaction_id`: 交易记录ID

**响应**: 空内容，状态码 204

---

## 报表生成 API

### 生成多维度收支报表

**请求**: `GET /reports/`

**描述**: 根据指定的时间维度、日期范围和分类生成收支报表

**查询参数**:
- `time_dimension` (可选): 时间维度，可选值：`daily`, `weekly`, `monthly`, `quarterly`, `custom`（默认为 "monthly"）
- `start` (可选): 自定义开始日期，格式：YYYY-MM-DD
- `end` (可选): 自定义结束日期，格式：YYYY-MM-DD
- `categories` (可选): 分类筛选，支持多分类英文逗号分隔

**响应示例**:
```json
{
  "time_dimension": "monthly",
  "period": "2024-12",
  "summary": {
    "total_income": 8000.0,
    "total_expense": 3500.0,
    "net_amount": 4500.0,
    "transaction_count": 25
  },
  "categories": [
    {
      "name": "工资",
      "total_amount": 8000.0,
      "transaction_count": 1,
      "percentage": 100.0
    },
    {
      "name": "餐饮",
      "total_amount": -1500.0,
      "transaction_count": 20,
      "percentage": 42.86
    }
  ],
  "transactions": [
    {
      "id": 1,
      "amount": 5000.0,
      "category": "工资",
      "tags": "收入,月度",
      "notes": "12月份工资",
      "created_at": "2024-12-01T09:00:00",
      "transaction_type": "收入"
    }
  ]
}
```

### 生成月度收支报表

**请求**: `GET /reports/monthly`

**描述**: 生成指定月份的收支报表，兼容旧接口

**查询参数**:
- `month` (可选): 月份，格式：YYYY-MM，默认为当前月

**响应**: 与多维度报表相同的格式

---

## 数据管理 API

### 创建数据库备份

**请求**: `POST /data/backup`

**描述**: 创建数据库备份文件，支持指定输出路径和强制覆盖

**查询参数**:
- `output_path` (可选): 指定备份文件路径（含文件名，后缀.db）
- `overwrite` (可选): 强制覆盖已有备份文件（默认为 false）

**响应示例**:
```json
{
  "status": "success",
  "message": "数据库备份成功",
  "backup_path": "/path/to/backup/cashlog_backup_20241201.db"
}
```

### 从备份文件恢复数据库

**请求**: `POST /data/restore`

**描述**: 从指定的备份文件恢复数据库，支持恢复前自动备份当前数据

**请求参数**:
- `input_file`: 备份文件（SQLite数据库文件，后缀.db）- 通过表单上传
- `backup_current` (可选): 恢复前自动备份当前数据库（默认为 true）
- `confirm` (可选): 确认恢复操作（默认为 true）

**响应示例**:
```json
{
  "status": "success",
  "message": "数据库恢复成功",
  "restored_from": "/path/to/backup/cashlog_backup_20241201.db",
  "current_backup_path": "/path/to/backup/auto_backup_20241201.db",
  "before_stats": {
    "transactions": 150,
    "todos": 25
  },
  "after_stats": {
    "transactions": 120,
    "todos": 20
  }
}
```

---

## 数据模型

### 待办事项 (Todo)

| 字段 | 类型 | 描述 | 必填 |
|------|------|------|------|
| id | Integer | 待办事项ID | 自动生成 |
| content | Text | 待办内容 | 是 |
| category | String(50) | 待办分类 | 是 |
| tags | String(200) | 待办标签 | 否 |
| deadline | DateTime | 截止时间 | 否 |
| transaction_id | Integer | 关联交易ID | 否 |
| status | Enum | 待办状态 (todo/doing/done) | 否，默认为 todo |
| created_at | DateTime | 创建时间 | 自动生成 |
| updated_at | DateTime | 更新时间 | 自动更新 |
| status_text | String | 状态中文描述 | 只读 |

### 交易记录 (Transaction)

| 字段 | 类型 | 描述 | 必填 |
|------|------|------|------|
| id | Integer | 交易记录ID | 自动生成 |
| amount | Float | 交易金额（正数为收入，负数为支出） | 是 |
| category | String(50) | 交易分类 | 是 |
| tags | String(200) | 交易标签 | 否 |
| notes | Text | 交易备注 | 否 |
| created_at | DateTime | 交易时间 | 否，默认为当前时间 |
| updated_at | DateTime | 更新时间 | 自动更新 |
| transaction_type | String | 交易类型（收入/支出） | 只读 |
| month | String | 交易年月（YYYY-MM） | 只读 |

---

## 错误处理

API 使用标准 HTTP 状态码表示请求结果：

- `200 OK`: 请求成功
- `201 Created`: 资源创建成功
- `204 No Content`: 请求成功，无返回内容
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 资源不存在
- `500 Internal Server Error`: 服务器内部错误

错误响应格式：
```json
{
  "detail": "错误描述信息"
}
```

---

## 分页

列表接口支持分页，使用以下查询参数：
- `page`: 页码（从1开始）
- `size`: 每页大小（默认为10）

分页响应格式：
```json
{
  "items": [...], // 数据列表
  "total": 100,   // 总记录数
  "page": 1,      // 当前页码
  "size": 10,     // 每页大小
  "pages": 10     // 总页数
}
```

---

## API 文档

启动 API 服务器后，可以通过以下 URL 访问交互式 API 文档：

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## 更新日志

### v1.0.0 (2024-12-01)
- 初始版本发布
- 实现待办事项 CRUD 操作
- 实现交易记录 CRUD 操作
- 实现多维度报表生成
- 实现数据备份与恢复功能